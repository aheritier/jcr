<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id = "WS.oAuth">
  <?dbhtml filename="ch-oauth.html"?>

  <title>oAuth</title>

  <section>
    <title>Overview</title>

    <para>OAuth allows to grant access to private resources on one site (which
    is called the Service Provider), to another site (called Consumer). OAuth
    is giving access to a resource without sharing your identity at all. More
    about oAuth at the site <link linkend="???">http://oauth.net/</link>.
    (OAuth protocol: <link
    linkend="???">http://oauth.net/core/1.0/</link>).</para>

    <para>This article describes how to configure our implementation of oAuth
    service and client part. Both parts, service (Provider) and client
    (Consumer) are based on oAuth core, this code can be found here <link
    linkend="???">http://oauth.googlecode.com/svn/code/java/core/</link>.</para>

    <para>Our implementation can be found here <link
    linkend="???">http://svn.exoplatform.org/svnroot/exoplatform/projects/ws/trunk/security/oauth</link>.</para>
  </section>

  <section>
    <title>Provider</title>

    <para>The provider consists of two parts oauthprovider.war and
    exo.ws.security.oauth.provider.service-trunk.jar. The main part of the
    provider is OAuthProviderService, currently there is one implementation of
    this interface
    org.exoplatform.ws.security.oauth.impl.OAuthProviderServiceMD5Impl; this
    component has few required configuration parameters.</para>

    <section>
      <title>Configuration</title>

      <para>The configuration is defined in the file configuration.xml.</para>

      <programlisting>&lt;component&gt;                                                                                                                
  &lt;type&gt;org.exoplatform.ws.security.oauth.impl.OAuthProviderServiceMD5Impl&lt;/type&gt;                                          
  &lt;init-params&gt;                                                                                                            
    &lt;properties-param&gt;                                                                                                     
      &lt;name&gt;exo1&lt;/name&gt;                                                                                                    
      &lt;property name="secret" value="81d1b5d080d1" /&gt;                                                                      
      &lt;property name="description" value="description" /&gt;                                                                  
      &lt;property name="callbackURL" value="http://localhost:8080/ws-examples/callback" /&gt;                                   
    &lt;/properties-param&gt;                                                                                                    
  &lt;/init-params&gt;                                                                                                           
&lt;/component&gt;</programlisting>

      <para>Properties:</para>

      <para>1. <command>name</command>: the name of provider, the client will
      send the name of provider that it wants to use.</para>

      <para>2. <command>secret</command>: this property is used for subscribe
      requests, this property must be known to the provider and the
      consumer.</para>

      <para>3. <command>description</command>: any description of the
      provider. Optional.</para>

      <para>4. <command>callbackURL</command>: this is URL where the client
      will be redirected after successful authentication by the
      provider.</para>

      <para>That is all what is needed for the configuration of the provider
      service. The next part of configuration is about web, such as
      servlets.</para>
    </section>

    <section>
      <title>Servlets</title>

      <para>The web part of the provider consists of 3 servlets:</para>

      <itemizedlist>
        <listitem>
          <para>OAuthRequestTokenServlet,</para>
        </listitem>

        <listitem>
          <para>OAuthAccessTokenServlet, and</para>
        </listitem>

        <listitem>
          <para>OAuthAuthorizationServlet</para>
        </listitem>
      </itemizedlist>

      <programlisting>&lt;?xml version="1.0" encoding="UTF-8"?&gt;                                                                                                                                                                         
&lt;web-app version="2.4" xmlns="http://java.sun.com/xml/ns/j2ee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee                                       
        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"&gt;                                                                                                                                                      
  &lt;display-name&gt;oAuth provider&lt;/display-name&gt;                                                                                                                                                                  
  &lt;context-param&gt;                                                                                                                                                                                              
    &lt;description&gt;Login page name&lt;/description&gt;                                                                                                                                                                 
    &lt;param-name&gt;login-page&lt;/param-name&gt;                                                                                                                                                                        
    &lt;param-value&gt;login/jsp/login.jsp&lt;/param-value&gt;                                                                                                                                                             
  &lt;/context-param&gt;                                                                                                                                                                                             
  &lt;servlet&gt;                                                                                                                                                                                                    
    &lt;servlet-name&gt;OAuthAuthenticationServlet&lt;/servlet-name&gt;                                                                                                                                                    
    &lt;servlet-class&gt;org.exoplatform.ws.security.oauth.http.OAuthAuthenticationServlet&lt;/servlet-class&gt;                                                                                                           
  &lt;/servlet&gt;                                                                                                                                                                                                   
  &lt;servlet&gt;                                                                                                                                                                                                    
    &lt;servlet-name&gt;OAuthRequestTokenServlet&lt;/servlet-name&gt;                                                                                                                                                      
    &lt;servlet-class&gt;org.exoplatform.ws.security.oauth.http.OAuthRequestTokenServlet&lt;/servlet-class&gt;                                                                                                             
  &lt;/servlet&gt;                                                                                                                                                                                                   
  &lt;servlet&gt;                                                                                                                                                                                                    
    &lt;servlet-name&gt;OAuthAccessTokenServlet&lt;/servlet-name&gt;                                                                                                                                                       
    &lt;servlet-class&gt;org.exoplatform.ws.security.oauth.http.OAuthAccessTokenServlet&lt;/servlet-class&gt;                                                                                                              
  &lt;/servlet&gt;                                                                                                                                                                                                   
  &lt;servlet-mapping&gt;                                                                                                                                                                                            
    &lt;servlet-name&gt;OAuthAuthenticationServlet&lt;/servlet-name&gt;                                                                                                                                                    
    &lt;url-pattern&gt;/authorize/*&lt;/url-pattern&gt;                                                                                                                                                                    
  &lt;/servlet-mapping&gt;                                                                                                                                                                                           
  &lt;servlet-mapping&gt;                                                                                                                                                                                            
    &lt;servlet-name&gt;OAuthRequestTokenServlet&lt;/servlet-name&gt;                                                                                                                                                      
    &lt;url-pattern&gt;/request_token/*&lt;/url-pattern&gt;                                                                                                                                                                
  &lt;/servlet-mapping&gt;                                                                                                                                                                                           
  &lt;servlet-mapping&gt;                                                                                                                                                                                            
    &lt;servlet-name&gt;OAuthAccessTokenServlet&lt;/servlet-name&gt;                                                                                                                                                       
    &lt;url-pattern&gt;/access_token/*&lt;/url-pattern&gt;                                                                                                                                                                 
  &lt;/servlet-mapping&gt;                                                                                                                                                                                           
&lt;/web-app&gt;</programlisting>
    </section>
  </section>

  <section>
    <title>Consumer</title>

    <para>The consumer consists of OAuthConsumerService and web part (servlets
    and filters).</para>

    <section>
      <title>How it works</title>

      <para>OAuthConsumerFilter checks cookies in client's request. The cookie
      must have the name _consumer_name_.oauth_token and
      _consumer_name_.oauth_token_secret. Then this filter try to find the
      request/access token this at OAuthConsumerService. If the token from the
      request is an access token then the client is already authenticated and
      gets access to requested resource.</para>

      <para>Otherwise the client will be redirected to the provider for
      authentication (see below, property "provider.authorizationURL"). This
      is the part of configuration.xml for the consumer:</para>

      <programlisting>&lt;component&gt;                                                                                                                                                                                                  
  &lt;type&gt;org.exoplatform.ws.security.oauth.impl.OAuthConsumerServiceImpl&lt;/type&gt;                                                                                                                               
  &lt;init-params&gt;                                                                                                                                                                                              
    &lt;value-param&gt;                                                                                                                                                                                            
      &lt;!-- this parameter MUST be set in minutes --&gt;                                                                                                                                                         
      &lt;name&gt;tokenAliveTime&lt;/name&gt;                                                                                                                                                                            
      &lt;value&gt;300&lt;/value&gt;                                                                                                                                                                                     
    &lt;/value-param&gt;                                                                                                                                                                                           
    &lt;properties-param&gt;                                                                                                                                                                                       
      &lt;name&gt;exo1&lt;/name&gt;                                                                                                                                                                                      
      &lt;property name="secret" value="81d1b5d080d1" /&gt;                                                                                                                                                        
      &lt;property name="description" value="description" /&gt;                                                                                                                                                    
      &lt;property name="provider.tokenRequestURL" value="http://localhost:8080/oauthprovider/request_token" /&gt;                                                                                                 
      &lt;property name="provider.authorizationURL" value="http://localhost:8080/oauthprovider/authorize" /&gt;                                                                                                    
      &lt;property name="provider.accessTokenURL" value="http://localhost:8080/oauthprovider/access_token" /&gt;                                                                                                   
    &lt;/properties-param&gt;                                                                                                                                                                                      
  &lt;/init-params&gt;                                                                                                                                                                                             
&lt;/component&gt;                                                                                                                                                                                                 
&lt;component&gt;                                                                                                                                                                                                  
  &lt;type&gt;org.exoplatform.ws.security.oauth.impl.OAuthClientHttpImpl&lt;/type&gt;                                                                                                                                    
&lt;/component&gt;                                                                                                                                                                                                 
&lt;component&gt;                                                                                                                                                                                                  
  &lt;type&gt;org.exoplatform.ws.security.oauth.impl.OAuthTokenCleanerImpl&lt;/type&gt;                                                                                                                                  
  &lt;init-params&gt;                                                                                                                                                                                              
  &lt;value-param&gt;                                                                                                                                                                                              
    &lt;!-- this parameter MUST be set in minutes --&gt;                                                                                                                                                           
    &lt;name&gt;tokenCleanerTimeout&lt;/name&gt;                                                                                                                                                                         
    &lt;value&gt;3&lt;/value&gt;                                                                                                                                                                                         
  &lt;/value-param&gt;                                                                                                                                                                                             
  &lt;/init-params&gt;                                                                                                                                                                                             
&lt;/component&gt;</programlisting>

      <para>The client is redirected for authentication to the provider with
      the required parameters (request and secret token), before this token
      OAuthClient got from the provider (see configuration, property
      "provider.tokenRequestURL"). On the provider side, the user (if the
      authentication is successful and has valid request parameters) will be
      redirected to the consumer again (see property "callbackURL" in the
      provider configuration). Then the consumer (this is, the same as
      receiving request token, invisible for the client) receives the access
      token, and redirects the client to the original URL. Then the filter
      checks the token from the request and gives access to the requested
      resource.</para>
    </section>

    <section>
      <title>web.xml</title>

      <para>This is the file web.xml for consumer application, in this example
      the resource http://localhost:8080/ws-examples/oauth/protected/ is under
      oAuth protect :</para>

      <programlisting>&lt;filter&gt;
&lt;filter-name&gt;OAuthConsumerFilter&lt;/filter-name&gt;     
  &lt;filter-class&gt;org.exoplatform.ws.security.oauth.http.OAuthConsumerFilter&lt;/filter-class&gt; 
 &lt;init-param&gt;
 &lt;param-name&gt;consumer&lt;/param-name&gt;
 &lt;param-value&gt;exo1&lt;/param-value&gt; 
&lt;/init-param&gt; &lt;/filter&gt;                                                                                                                                                                                                    &lt;filter&gt;
&lt;filter-name&gt;OAuthRequestWrapperFilter&lt;/filter-name&gt; 
&lt;filter-class&gt;org.exoplatform.ws.security.oauth.http.OAuthRequestWrapperFilter&lt;/filter-class&gt; &lt;/filter&gt;                                                                                                                                                                                                    
                                                                                                                                                                                                              &lt;filter-mapping&gt;
&lt;filter-name&gt;OAuthConsumerFilter&lt;/filter-name&gt;   
&lt;url-pattern&gt;/oauth/protected/*&lt;/url-pattern&gt;  
&lt;/filter-mapping&gt;
&lt;filter-mapping&gt;
&lt;filter-name&gt;OAuthRequestWrapperFilter&lt;/filter-name&gt; 
&lt;url-pattern&gt;/oauth/protected/*&lt;/url-pattern&gt;   
&lt;/filter-mapping&gt;</programlisting>

      <para>Any resource can be protected by this mechanism under the
      condition that web.xml is configured to use OAuthConsumerFilter. Client
      must save the given access and the secret token in a cookie.</para>
    </section>

    <section>
      <title>Stages</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="images/oauth-scheme.png" />
        </imageobject>
      </mediaobject>

      <para>1. continuous line - client's redirections</para>

      <para>2. fine dashed line - internal oAuth schema requests and
      responses.</para>

      <para>Stages:</para>

      <para>1. green - stage 1 (receiving request token)</para>

      <para>2. yellow - stage 2 (authentication)</para>

      <para>3. blue - stage 3 (receiving access token)</para>

      <para>4. red - stage 4 (get protected resource)</para>
    </section>

    <section>
      <title>Token Alive Time</title>

      <para>Alive time for tokens can be set using the parameter
      tokenAliveTime.</para>

      <programlisting>&lt;value-param&gt;
  &lt;!-- this parameter MUST be set in minutes --&gt;
  &lt;name&gt;tokenAliveTime&lt;/name&gt;
  &lt;value&gt;300&lt;/value&gt;
&lt;/value-param&gt;</programlisting>
    </section>

    <section>
      <title>Token Cleaner Timeout</title>

      <para>There is special component cleaner on consumer side, it starts, by
      default, every 5 minutes and checks all tokens. If it finds token with
      expired time it removes it from the storage. Token cleaner timeout (how
      often it must run) can be also set in the configuration:</para>

      <programlisting>&lt;component&gt;
    &lt;type&gt;org.exoplatform.ws.security.oauth.impl.OAuthTokenCleanerImpl&lt;/type&gt;
    &lt;init-params&gt;
    &lt;value-param&gt;
      &lt;!-- this parameter MUST be set in minutes --&gt;
      &lt;name&gt;tokenCleanerTimeout&lt;/name&gt;
      &lt;value&amp;#623;&lt;/value&gt;
    &lt;/value-param&gt;
    &lt;/init-params&gt;
  &lt;/component&gt;</programlisting>
    </section>
  </section>
</chapter>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter>
  <?dbhtml filename="cluster-config.html"?>

  <title>Configuring JBoss AS with eXo JCR in cluster</title>

  <section>
    <title>Launching Cluster</title>

    <section>
      <title>Deploying eXo JCR to JBoss As</title>

      <para>To deploy eXo JCR to JBoss As follow next steps:</para>

      <orderedlist>
        <listitem>
          <para>Dowload the latest version of eXo JCR ear distribution.</para>
        </listitem>

        <listitem>
          <para>Copy &lt;jcr.ear&gt; into
          &lt;%jboss_home%/server/default/deploy&gt;</para>
        </listitem>

        <listitem>
          <para>Put exo-configuration.xml to the root
          &lt;%jboss_home%/exo-configuration.xml&gt;</para>
        </listitem>

        <listitem>
          <para>Configure JAAS by inserting XML fragment shown below into
          &lt;%jboss_home%/server/default/conf/login-config.xml&gt;</para>

          <programlisting>&lt;application-policy name="exo-domain"&gt;
   &lt;authentication&gt;
      &lt;login-module code="org.exoplatform.services.security.j2ee.JbossLoginModule" flag="required"&gt;&lt;/login-module&gt;
   &lt;/authentication&gt;
&lt;/application-policy&gt;</programlisting>
        </listitem>

        <listitem>
          <para>Ensure that you use JBossTS <link
          linkend="ch_transaction_service">Transaction Service</link> and
          JBossCache <link
          linkend="ch-jbossts-tranasction-service">Transaction Manager</link>.
          Your exo-configuration.xml must contain such parts:</para>

          <programlisting>&lt;component&gt;
   &lt;key&gt;org.jboss.cache.transaction.TransactionManagerLookup&lt;/key&gt;
   &lt;type&gt;org.jboss.cache.GenericTransactionManagerLookup&lt;/type&gt;^
&lt;/component&gt;

&lt;component&gt;
   &lt;key&gt;org.exoplatform.services.transaction.TransactionService&lt;/key&gt;
   &lt;type&gt;org.exoplatform.services.transaction.jbosscache.JBossTransactionsService&lt;/type&gt;
   &lt;init-params&gt;
      &lt;value-param&gt;
         &lt;name&gt;timeout&lt;/name&gt;
         &lt;value&gt;300&lt;/value&gt;
      &lt;/value-param&gt;
   &lt;/init-params&gt;
&lt;/component&gt;</programlisting>
        </listitem>

        <listitem>
          <para>Start server:</para>

          <itemizedlist>
            <listitem>
              <para>bin/run.sh for Unix</para>
            </listitem>

            <listitem>
              <para>bin/run.bat for Windows</para>
            </listitem>
          </itemizedlist>
        </listitem>

        <listitem>
          <para>Try accessing <ulink
          url="http://localhost:8080/browser">http://localhost:8080/browser</ulink>
          with root/exo as login/password if you have done everything right,
          you'll get access to repository browser.</para>
        </listitem>
      </orderedlist>
    </section>

    <section id="sect_conf_cluster_jcr">
      <title>Configuring JCR to use external configuration</title>

      <itemizedlist>
        <listitem>
          <para>To manually configure repository create a new configuration
          file (f.e. exo-jcr-configuration.xml). For details see <ulink
          url="http://wiki.exoplatform.org/xwiki/bin/view/JCR/#HConfiguration">JCR
          Configuration</ulink>. Your configuration must look like:</para>

          <programlisting>&lt;repository-service default-repository="repository1"&gt;
   &lt;repositories&gt;
      &lt;repository name="repository1" system-workspace="ws1" default-workspace="ws1"&gt;
         &lt;security-domain&gt;exo-domain&lt;/security-domain&gt;
         &lt;access-control&gt;optional&lt;/access-control&gt;
         &lt;authentication-policy&gt;org.exoplatform.services.jcr.impl.core.access.JAASAuthenticator&lt;/authentication-policy&gt;
         &lt;workspaces&gt;
            &lt;workspace name="ws1"&gt;
               &lt;container class="org.exoplatform.services.jcr.impl.storage.jdbc.optimisation.CQJDBCWorkspaceDataContainer"&gt;
                  &lt;properties&gt;
                     &lt;property name="source-name" value="jdbcjcr" /&gt;
                     &lt;property name="dialect" value="oracle" /&gt;
                     &lt;property name="multi-db" value="false" /&gt;
                     &lt;property name="update-storage" value="false" /&gt;
                     &lt;property name="max-buffer-size" value="200k" /&gt;
                     &lt;property name="swap-directory" value="../temp/swap/production" /&gt;
                  &lt;/properties&gt;
                  &lt;value-storages&gt;
                     see "<link linkend="conf_value_storage">Value storage configuration</link>" part.
                  &lt;/value-storages&gt;
               &lt;/container&gt;
               &lt;initializer class="org.exoplatform.services.jcr.impl.core.ScratchWorkspaceInitializer"&gt;
                  &lt;properties&gt;
                     &lt;property name="root-nodetype" value="nt:unstructured" /&gt;
                  &lt;/properties&gt;
               &lt;/initializer&gt;
               &lt;cache enabled="true" class="org.exoplatform.services.jcr.impl.dataflow.persistent.jbosscache.JBossCacheWorkspaceStorageCache"&gt;
                     see  "<link linkend="conf_cache">Cache configuration</link>" part.
               &lt;/cache&gt;
               &lt;query-handler class="org.exoplatform.services.jcr.impl.core.query.lucene.SearchIndex"&gt;
                  see  "<link linkend="conf_indexer">Indexer configuration</link>" part.
               &lt;/query-handler&gt;
               &lt;lock-manager class="org.exoplatform.services.jcr.impl.core.lock.jbosscache.CacheableLockManagerImpl"&gt;
                  see  "<link linkend="conf_lock_manager">Lock Manager configuration</link>" part.
               &lt;/lock-manager&gt;
            &lt;/workspace&gt;
            &lt;workspace name="ws2"&gt;
                        ...
            &lt;/workspace&gt;
            &lt;workspace name="wsN"&gt;
                        ...
            &lt;/workspace&gt;
         &lt;/workspaces&gt;
      &lt;/repository&gt;
   &lt;/repositories&gt;
&lt;/repository-service&gt; </programlisting>
        </listitem>

        <listitem>
          <para>and update RepositoryServiceConfiguration configuration in
          exo-configuration.xml to use this file:<programlisting>&lt;component&gt;
   &lt;key&gt;org.exoplatform.services.jcr.config.RepositoryServiceConfiguration&lt;/key&gt;
   &lt;type&gt;org.exoplatform.services.jcr.impl.config.RepositoryServiceConfigurationImpl&lt;/type&gt;
   &lt;init-params&gt;
      &lt;value-param&gt;
         &lt;name&gt;conf-path&lt;/name&gt;
         &lt;description&gt;JCR configuration file&lt;/description&gt;
         &lt;value&gt;exo-jcr-configuration.xml&lt;/value&gt;
      &lt;/value-param&gt;
   &lt;/init-params&gt;
&lt;/component&gt;</programlisting></para>
        </listitem>
      </itemizedlist>
    </section>
  </section>

  <section>
    <title>Requirements</title>

    <section>
      <title>Enviorenment requirements</title>

      <itemizedlist>
        <listitem>
          <para>Every node of cluster MUST have the same mounted Network File
          System with read and write permissions on it.</para>

          <para>"/mnt/tornado" - path to the mounted Network File System (all
          cluster nodes must use the same NFS)</para>
        </listitem>

        <listitem>
          <para>Every node of cluster MUST use the same database</para>
        </listitem>

        <listitem>
          <para>Same Clusters on different nodes MUST have the same cluster
          names (f.e if Indexer cluster in workspace production on the first
          node has name "production_indexer_cluster", then indexer clusters in
          workspace production on all other nodes MUST have the same name
          "production_indexer_cluster" )</para>
        </listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Enviorenment requirements</title>

      <para>Configuration of every workspace in repository must contains of
      such parts:</para>

      <itemizedlist>
        <listitem id="conf_value_storage">
          <para>Value Storage configuration:</para>

          <programlisting>&lt;value-storages&gt;
   &lt;value-storage id="system" class="org.exoplatform.services.jcr.impl.storage.value.fs.TreeFileValueStorage"&gt;
      &lt;properties&gt;
         &lt;property name="path" value="/mnt/tornado/temp/values/production" /&gt;    &lt;!--path within NFS where ValueStorage will hold it's data--&gt;
      &lt;/properties&gt;
      &lt;filters&gt;
         &lt;filter property-type="Binary" /&gt;
      &lt;/filters&gt;
   &lt;/value-storage&gt;
&lt;/value-storages&gt;</programlisting>
        </listitem>

        <listitem id="conf_cache">
          <para>Cache configuration:</para>

          <programlisting>&lt;cache enabled="true" class="org.exoplatform.services.jcr.impl.dataflow.persistent.jbosscache.JBossCacheWorkspaceStorageCache"&gt;
   &lt;properties&gt;
      &lt;property name="jbosscache-configuration" value="jar:/conf/portal/test-jbosscache-data.xml" /&gt;     &lt;!--    path to JBoss Cache configuration for data storage --&gt;
      &lt;property name="jgroups-configuration" value="jar:/conf/portal/udp-mux.xml" /&gt;                     &lt;!--    path to JGroups configuration --&gt;
      &lt;property name="jbosscache-cluster-name" value="JCR_Cluster_cache_production" /&gt;                   &lt;!--    JBoss Cache data storage cluster name --&gt;
      &lt;property name="jgroups-multiplexer-stack" value="true" /&gt;
   &lt;/properties&gt;
&lt;/cache&gt; </programlisting>
        </listitem>

        <listitem id="conf_indexer">
          <para>Indexer configuration:</para>

          <programlisting>&lt;query-handler class="org.exoplatform.services.jcr.impl.core.query.lucene.SearchIndex"&gt;
   &lt;properties&gt;
      &lt;property name="changesfilter-class" value="org.exoplatform.services.jcr.impl.core.query.jbosscache.JBossCacheIndexChangesFilter" /&gt;
      &lt;property name="index-dir" value="/mnt/tornado/temp/jcrlucenedb/production" /&gt;                       &lt;!--    path within NFS where ValueStorage will hold it's data --&gt;
      &lt;property name="jbosscache-configuration" value="jar:/conf/portal/test-jbosscache-indexer.xml" /&gt;    &lt;!--    path to JBoss Cache configuration for indexer --&gt;
      &lt;property name="jgroups-configuration" value="jar:/conf/portal/udp-mux.xml" /&gt;                       &lt;!--    path to JGroups configuration --&gt;
      &lt;property name="jbosscache-cluster-name" value="JCR_Cluster_indexer_production" /&gt;                   &lt;!--    JBoss Cache indexer cluster name --&gt;
      &lt;property name="jgroups-multiplexer-stack" value="true" /&gt;
   &lt;/properties&gt;
&lt;/query-handler&gt; </programlisting>
        </listitem>

        <listitem id="conf_lock_manager">
          <para>Lock Manager configuration:</para>

          <programlisting>&lt;lock-manager class="org.exoplatform.services.jcr.impl.core.lock.jbosscache.CacheableLockManagerImpl"&gt;
   &lt;properties&gt;
      &lt;property name="time-out" value="15m" /&gt;
      &lt;property name="jbosscache-configuration" value="jar:/conf/portal/test-jbosscache-lock.xml" /&gt;       &lt;!--    path to JBoss Cache configuration for lock manager --&gt;
      &lt;property name="jgroups-configuration" value="jar:/conf/portal/udp-mux.xml" /&gt;                       &lt;!--    path to JGroups configuration --&gt;
      &lt;property name="jgroups-multiplexer-stack" value="true" /&gt;
      &lt;property name="jbosscache-cluster-name" value="JCR_Cluster_lock_production" /&gt;                      &lt;!--    JBoss Cache locks cluster name --&gt;
                     
      &lt;property name="jbosscache-cl-cache.jdbc.table.name" value="jcrlocks_production"/&gt;                   &lt;!--    the name of the DB table where lock's data will be stored --&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.table.create" value="true"/&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.table.drop" value="false"/&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.table.primarykey" value="jcrlocks_production_pk"/&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.fqn.column" value="fqn"/&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.node.column" value="node"/&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.parent.column" value="parent"/&gt;
      &lt;property name="jbosscache-cl-cache.jdbc.datasource" value="jdbcjcr"/&gt;
   &lt;/properties&gt;
&lt;/lock-manager&gt;</programlisting>
        </listitem>
      </itemizedlist>
    </section>
  </section>
</chapter>

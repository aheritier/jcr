<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter>
  <?dbhtml filename="ch-ws.html"?>

  <title>Cometd Cluster Bench</title>

  <section>
    <title>How we test</title>

    <para>We simple open many connection, all client subscribing to one
    channel, we don't send any message to client, they reconnect through
    120000 ms. Settings for cometd servlet.</para>

    <programlisting>&lt;servlet&gt;
    &lt;servlet-name&gt;cometd&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.mortbay.cometd.continuation.EXoContinuationCometdServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;filters&lt;/param-name&gt;
      &lt;param-value&gt;/WEB-INF/filters.json&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;timeout&lt;/param-name&gt;
      &lt;param-value&gt;120000&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;interval&lt;/param-name&gt;
      &lt;param-value&gt;0&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;multiFrameInterval&lt;/param-name&gt;
      &lt;param-value&gt;1500&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;logLevel&lt;/param-name&gt;
      &lt;param-value&gt;0&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;JSONCommented&lt;/param-name&gt;
      &lt;param-value&gt;false&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;alwaysResumePoll&lt;/param-name&gt;
      &lt;param-value&gt;false&lt;/param-value&gt; &lt;!-- use true for x-site cometd --&gt;
    &lt;/init-param&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
  &lt;/servlet&gt;</programlisting>
  </section>

  <section>
    <title>Environment</title>

    <para>Test running on our server for testing (Tornado)</para>

    <para>Processor : Intel(R) Xeon(R) CPU E5345 @ 2.33GHz (8 cores)</para>

    <para>RAM : 16 GB</para>

    <para>java version "1.5.0_15" (64-bit)</para>
  </section>

  <section>
    <title>Result</title>

    <table>
      <title></title>

      <tgroup cols="4">
        <thead>
          <row>
            <entry align="center">Connection</entry>

            <entry align="center">Heap (JProfiler), mb</entry>

            <entry align="center">Virt (top),gb</entry>

            <entry align="center">res (top), gb</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>1000</entry>

            <entry>239</entry>

            <entry>-</entry>

            <entry>-</entry>
          </row>

          <row>
            <entry>2000</entry>

            <entry>318</entry>

            <entry>-</entry>

            <entry>-</entry>
          </row>

          <row>
            <entry>3000</entry>

            <entry>450</entry>

            <entry>6</entry>

            <entry>1.36</entry>
          </row>

          <row>
            <entry>4000</entry>

            <entry>610</entry>

            <entry>7.2</entry>

            <entry>1.6</entry>
          </row>

          <row>
            <entry>5000</entry>

            <entry>767</entry>

            <entry>12.9</entry>

            <entry>1.7</entry>
          </row>

          <row>
            <entry>6000</entry>

            <entry>895</entry>

            <entry>14.4</entry>

            <entry>1.8</entry>
          </row>

          <row>
            <entry>7000</entry>

            <entry>1004</entry>

            <entry>15.5</entry>

            <entry>2.2</entry>
          </row>

          <row>
            <entry>8000</entry>

            <entry>1116</entry>

            <entry>17.3</entry>

            <entry>2.6</entry>
          </row>

          <row>
            <entry>9000</entry>

            <entry>1295</entry>

            <entry>29.6</entry>

            <entry>9.8</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <mediaobject>
      <imageobject>
        <imagedata fileref="images/cometd-bench.png" />
      </imageobject>
    </mediaobject>

    <para>In screenshot red line show thousand of connection. Then count of
    connection be 9000 the test fail, with exception connection
    timeout.</para>
  </section>
</chapter>

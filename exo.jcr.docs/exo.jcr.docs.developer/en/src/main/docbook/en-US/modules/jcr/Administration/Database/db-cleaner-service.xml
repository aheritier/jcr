<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<section id="JCR.DBCleanerService" role="NotInToc">
  <title>DBCleanService</title>

    <para>It is a special service for data removal from database. The section
    shortly describes the working principles of <emphasis>DBCleaner</emphasis> under all
    databases.</para>

	<itemizedlist>
    <listitem>
      <para xml:id="JCR.DBCleanerService.Methods_of_DBCleanerService"><emphasis role="bold">Methods of DBCleanerService</emphasis></para>
     <note>
      <para>Code that invokes the methods of DBCleanService must have
      the <emphasis>JCRRuntimePermissions.MANAGE_REPOSITORY_PERMISSION</emphasis> permission.</para>
    </note>

    <para>There are several methods of <emphasis>DBCleanerService</emphasis> :</para>

    <table>
      <title>API</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry><parameter>public static void cleanWorkspaceData(WorkspaceEntry
            wsEntry)</parameter></entry>

            <entry>Clean workspace data from database.</entry>
          </row>

          <row>
            <entry><parameter>public static void cleanRepositoryData(RepositoryEntry
            repoEntry)</parameter></entry>

            <entry>Clean up repository data from database.</entry>
          </row>

          <row>
            <entry><parameter>public static DBCleaner getWorkspaceDBCleaner(Connection
            jdbcConn, WorkspaceEntry wsEntry)</parameter></entry>

            <entry>Return database cleaner of workspace.</entry>
          </row>

          <row>
            <entry><parameter>public static DBCleaner getRepositoryDBCleaner(Connection
            jdbcConn, RepositoryEntry repoEntry)</parameter></entry>

            <entry>Return database cleaner of repository. Returns null in
            case of multi-db configuration.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>The cleaning is a part of restoring from backup and it is used in
    the following restore phases: </para>

    <table>
      <title>Relations between restore phases and what is called on
      DBCleaner</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry>clean</entry>

            <entry><programlisting language="java">dbCleaner.executeCleanScripts();</programlisting></entry>
          </row>

          <row>
            <entry><parameter>restore</parameter></entry>

            <entry>Does nothing with DBCleaner.</entry>
          </row>

          <row>
            <entry><parameter>commit</parameter></entry>

            <entry><programlisting language="java">dbCleaner.executeCommitScripts();
connection.commit();</programlisting></entry>
          </row>

          <row>
            <entry><parameter>rollback</parameter></entry>

            <entry><programlisting language="java">connection.rollback();

dbCleaner.executeRollbackScripts();
connection.commit();</programlisting></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>Different approaches are used for database cleaning depending on
    database and JCR configuration.</para>
  </listitem>

  <listitem>
    <para xml:id="JCR.DBCleanerService.Clean_Only_Single_Workspace"><emphasis role="bold">Need to clean only single workspace</emphasis></para>

    <para>Simple cleaning records from JCR table is used in case of single-db
    configuration. </para>

    <table>
      <title>PostgreSQL, DB2 and MSSQL </title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry><parameter>executeCleanScripts()</parameter></entry>

            <entry>Remove all records from the database. Foreign key of
            JCR_SITEM table is also removed.</entry>
          </row>

          <row>
            <entry><parameter>executeCommitScripts()</parameter></entry>

            <entry>Add the foreign key.</entry>
          </row>

          <row>
            <entry><parameter>executeRollbackScripts()</parameter></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Oracle, Sybase, HSQLDB, MySQL</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry><parameter>executeCleanScripts()</parameter></entry>

            <entry>Remove all records from the database. Foreign key of
            JCR_SITEM table is also removed.</entry>
          </row>

          <row>
            <entry><parameter>executeCommitScripts()</parameter></entry>

            <entry>Add the foreign key.</entry>
          </row>

          <row>
            <entry><parameter>executeRollbackScripts()</parameter></entry>

            <entry>Add the foreign key.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>Either removing or renaming JCR tables are used in case of mult-db
    configuration.</para>

    <table>
      <title>PostgreSQL, DB2 and MSSQL</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry>executeCleanScripts()</entry>

            <entry>Remove the tables JCR_MVALUE, JCR_MREF, JCR_MITEM,
            initialize new tables without the foreign key of JCR_MITEM table,
            add root.</entry>
          </row>

          <row>
            <entry>executeCommitScripts()</entry>

            <entry>Add the foreign key.</entry>
          </row>

          <row>
            <entry>executeRollbackScripts()</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Oracle, Sybase, HSQLDB, MySQL</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry>executeCleanScripts()</entry>

            <entry>Rename the current tables, initialize new tables without
            the foreign key of the JCR_MITEM table, add root node, and remove indexes
            for some databases.</entry>
          </row>

          <row>
            <entry>executeCommitScripts()</entry>

            <entry>Rename tables, and add indexes.</entry>
          </row>

          <row>
            <entry>executeRollbackScripts()</entry>

            <entry>Remove the previously renamed tables, add indexes, and add
            foreign key.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </listitem>

  <listitem>
    <para xml:id="JCR.DBCleanerService.Clean_Whole_Reposistory"><emphasis role="bold">Need to clean the whole repository</emphasis></para>

    <para>In case of single-db, all workspaces will be processed simultaneously
    as in case of single workspace multi-db configuration. For multi-db, every
    workspace will be processed separately as in case of single workspace
    multi-db configuration.</para>
  </listitem>
</itemizedlist>
</section>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<!--3.2.1.2.2. Access control system-->
<section id="JCR.AccessControlExtension">
  <title>Access control system</title>

  <para>An extended Access Control system consists of:</para>

    <itemizedlist>
      <listitem>
        <para>Specifically configured custom <parameter>ExtendedAccessManager</parameter> which is called by eXo
        JCR internals to check if user's Session (user) has some privileges to
        perform some operations or not.</para>
      </listitem>

      <listitem>
        <para>The <emphasis role="bold">Action</emphasis> sets a thread local
        <parameter>InvocationContext</parameter> at runtime, the
        InvocationContext instance is then used by the <parameter>ExtendedAccessManager</parameter>
        in handling permissions of the current Session.</para>
      </listitem>

      <listitem>
        <para><parameter>InvocationContext</parameter> is a
        collection of properties which reflect the state of a current Session.
        At present, it contains: the type of the current operation on Session
        (event), current Item (javax.jcr.Item) on which this operation is
        performed and the current eXo Container.</para>
      </listitem>
    </itemizedlist>

  <para xml:id="JCR.AccessControlExtension.AccessContextAction">
    <citetitle>
      <emphasis role="bold">Access context action</emphasis>
    </citetitle>
  </para>

    <para><parameter>SetAccessControlContextAction</parameter> implements Action and may be called by
    <parameter>SessionActionInterceptor</parameter> as a reaction of some events - usually before
    writing methods and after reading (<parameter>getNode(), getProperty()</parameter>, and  more). This
    <parameter>SetAccessControlContextAction</parameter> calls the
    <parameter>AccessManager.setContext(InvocationContext context)</parameter> method which sets the
    ThreadLocal invocation context for the current call.</para>

    <para>Action's configuration may look like as the following:</para>

    <programlisting language="xml">&lt;value&gt;
  &lt;object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration"&gt;
    &lt;field  name="eventTypes"&gt;&lt;string&gt;addNode,read&lt;/string&gt;&lt;/field&gt;
    &lt;field  name="workspace"&gt;&lt;string&gt;production&lt;/string&gt;&lt;/field &gt;
    &lt;field  name="actionClassName"&gt;&lt;string&gt;org.exoplatform.services.jcr.ext.access.SetAccessControlContextAction&lt;/string&gt;&lt;/field&gt;       
  &lt;/object&gt;
&lt;/value&gt;</programlisting>

  <para xml:id="JCR.AccessControlExtension.InvocationContext">
    <citetitle>
      <emphasis role="bold">Invocation context</emphasis>
    </citetitle>
  </para>

    <para>The <emphasis role="bold">InvocationContext</emphasis> contains the
    current Item, the current <parameter>ExoContainer</parameter> and the current <parameter>EventType</parameter> look like
    below:</para>

    <programlisting language="java">public interface InvocationContext extends ContextBase {

  Item getCurrentItem();

  int getEventType();
  
  ExoContainer getContainer();
}</programlisting>

  <para xml:id="JCR.AccessControlExtension.CustomExtendedAccessManager">
    <citetitle>
      <emphasis role="bold">Custom extended access manager</emphasis>
    </citetitle>
  </para>

    <para>By default, all workspaces share an <parameter>AccessManager</parameter> instance, created
    by <parameter>RepositoryService</parameter> at the startup (<parameter>DefaultAccessManagerImpl</parameter>) which
    supports default access control policy as described in the <emphasis
    role="bold"><link linkend="JCR.AccessControl">Access Control</link></emphasis> section. Custom Access Control
    policy can be applied to certain Workspace configuring <parameter>access-manager</parameter> element inside <parameter>workspace</parameter> as follows:</para>

    <programlisting language="xml">&lt;workspace name="ws"&gt;        
   ...
   &lt;!-- after query-handler element --&gt;
   &lt;access-manager class="org.exoplatform.services.jcr.CustomAccessManagerImpl"&gt;
      &lt;properties&gt;
         &lt;property name="someProperty" value="value"/&gt;
         ...
      &lt;/properties&gt;
  &lt;/access-manager&gt;
  ...
&lt;/workspace&gt;</programlisting>

    <para>When implementing <parameter>AccessManager</parameter>, the <parameter>hasPermission()</parameter> method has to be
    overridden so it uses the current invocation context at its discretion. For
    instance, it may get the current node's metadata and make a decision if
    the current User has appropriate permissions. Use Invocation Context's
    runtime properties to make a decision about current Session's privileges.
    </para>

    <para>For example: The following is a simplified Sequence diagram for the <parameter>Session.getNode()</parameter> method:</para>

    <mediaobject>
      <imageobject>
        <imagedata fileref="images/other/acl-ext.jpg" />
      </imageobject>
    </mediaobject>

  <para xml:id="JCR.AccessControlExtension.ExampleCustomAccessManager">
    <citetitle>
      <emphasis role="bold">Example of a custom access manager</emphasis>
    </citetitle>
  </para>

    <para>The sample <parameter>CustomAccessManagerImpl</parameter> below extends the default access
    manager and uses some <parameter>DecisionMakingService</parameter> in the overloaded
    <parameter>hasPermission</parameter> method to find out if a current user has permission to use
    current <emphasis role="bold">item, event type, user</emphasis> and some
    parameters of <parameter>AccessManager</parameter>. To make this Access manager work, it is
    necessary to configure it in the JCR configuration as mentioned in <emphasis
    role="bold"><link linkend="JCR.AccessControlExtension.CustomExtendedAccessManager"> Extended Access Manager</link></emphasis> and
    <parameter>SetAccessControlContextAction</parameter> should be configured in the way mentioned in
    <emphasis role="bold"><link linkend="JCR.AccessControlExtension.AccessContextAction">Access Context Action</link></emphasis>.</para>

    <programlisting language="java">public class CustomAccessManagerImpl extends AccessManager {

  private String property;
  private DecisionMakingService theService;

  public CustomAccessManagerImpl (RepositoryEntry config, WorkspaceEntry wsConfig,
      DecisionMakingService someService) throws RepositoryException, RepositoryConfigurationException {
    super(config, wsConfig);
    this.property = wsConfig.getAccessManager().getParameterValue("someParam");
    this.theService = someService;
  }

  @Override
  public boolean hasPermission(AccessControlList acl, String[] permission, Identity user) {
    // call the default permission check
    if (super.hasPermission(acl, permission, user)) {
      
      Item curItem = context().getCurrentItem();
      int eventType = context().getEventType();
      ExoContainer container = context().getContainer();

      // call some service's method
      return theService.makeDecision(curItem, eventType, user, property);
    } else {
      return false;
    }
  }
}</programlisting>
</section>

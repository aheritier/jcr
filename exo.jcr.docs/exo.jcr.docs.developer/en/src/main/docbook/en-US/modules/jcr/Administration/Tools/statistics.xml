<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<section id="JCR.Statistics" role="NotInToc">
  <title>JCR statistics</title>
  <para>This section will show you how to get and manage all statistics provided by eXo JCR.
 All the statistics are controlled by the statistics manager which is reponsible for printing data into the CSV files and  exposing the statistics through JMX and/or Rest.
  </para>
  <para xml:id="JCR.Statistics.Statistics_Manager">
    <citetitle><emphasis role="bold">Statistics Manager</emphasis></citetitle>
  </para>
    <para>The statistics manager will create all the CSV files for each category of statistics under its management. These files are in the format of
    <filename>Statistics${category-name}-${creation-timestamp}.csv</filename>.
    Those files will be created into the user directory if it is possible
    otherwise it will create them into the temporary directory. The <filename>.csv</filename> files (for example, Comma-Separated Values) includes: one new line which is added regularly (every 5 seconds by default) and one last line which will be added at JVM exit.
      Each line has 5 figures described below for each method and globally for all methods.
</para>

    <table>
        <title>Metric Alias</title>

        <tgroup cols="2">
          <tbody>
            <row>
              <entry><parameter>Min</parameter></entry>

              <entry>The minimum time spent into the method expressed in
              milliseconds.</entry>
            </row>

            <row>
              <entry><parameter>Max</parameter></entry>

              <entry>The maximum time spent into the method expressed in
              milliseconds.</entry>
            </row>

            <row>
              <entry><parameter>Total</parameter></entry>

              <entry>The total amount of time spent into the method expressed
              in milliseconds.</entry>
            </row>

            <row>
              <entry><parameter>Avg</parameter></entry>

              <entry>The average time spent into the method expressed in
              milliseconds.</entry>
            </row>

            <row>
              <entry><parameter>Times</parameter></entry>

              <entry>The total amount of times the method has been
              called.</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
      <para>
      By default, the JVM parameter called
      <parameter>JCRStatisticsManager.persistence.enabled</parameter>
      is set to "true".
      Also, the <parameter>JCRStatisticsManager.persistence.timeout</parameter> JVM parameter that shows period between each record (for
      example, line of data into the file) is set to 5000. You can define another periods by setting its value to your
      desired one in milliseconds.
    </para>

  <para>You can also access the statistics thanks to JMX, the available
    methods are the following:</para>

    <para><table>
        <title>JMX Methods</title>

        <tgroup cols="2">
          <tbody>
            <row>
              <entry><parameter>getMin</parameter></entry>

              <entry>Give the minimum time spent into the method corresponding
              to the given category name and statistics name. The expected
              arguments are the name of the category of statistics (for example,
              <parameter>JDBCStorageConnection</parameter>) and the name of the expected method or
              global for the global value.</entry>
            </row>

            <row>
              <entry><parameter>getMax</parameter></entry>

              <entry>Give the maximum time spent into the method corresponding
              to the given category name and statistics name. The expected
              arguments are the name of the category of statistics (for example,
              <parameter>JDBCStorageConnection</parameter>) and the name of the expected method or
              global for the global value.</entry>
            </row>

            <row>
              <entry><parameter>getTotal</parameter></entry>

              <entry>Give the total amount of time spent into the method
              corresponding to the given category name and statistics name.
              The expected arguments are the name of the category of
              statistics (for example, <parameter>JDBCStorageConnection</parameter>) and the name of the
              expected method or global for the global value.</entry>
            </row>

            <row>
              <entry><parameter>getAvg</parameter></entry>

              <entry>Give the average time spent into the method corresponding
              to the given category name and statistics name. The expected
              arguments are the name of the category of statistics (for example,
              <parameter>JDBCStorageConnection</parameter>) and the name of the expected method or
              global for the global value.</entry>
            </row>

            <row>
              <entry><parameter>getTimes</parameter></entry>

              <entry>Give the total amount of times the method has been called
              corresponding to the given category name and statistics name.
              The expected arguments are the name of the category of
              statistics (for example, <parameter>JDBCStorageConnection</parameter>) and the name of the
              expected method or global for the global value.</entry>
            </row>

            <row>
              <entry><parameter>reset</parameter></entry>

              <entry>Reset the statistics for the given category name and
              statistics name. The expected arguments are the name of the
              category of statistics (for example, <parameter>JDBCStorageConnection</parameter>) and the name
              of the expected method or global for the global value.</entry>
            </row>

            <row>
              <entry><parameter>resetAll</parameter></entry>

              <entry>Reset all the statistics for the given category name. The
              expected argument is the name of the category of statistics
              (for example, <parameter>JDBCStorageConnection</parameter>).</entry>
            </row>
          </tbody>
        </tgroup>
      </table>The full name of the related MBean is
    <parameter>exo:service=statistic, view=jcr</parameter>.</para>

  <section id="JCR.Statistics.Database_access_layer">
    <title>Statistics on database access layer</title>

    <para>In order to have a better idea of the time spent into the database
    access layer, it can be interesting to get some statistics on that part of
    the code, knowing that most of the time spent into eXo JCR is mainly the
    database access. This statistics will then allow you to identify without
    using any profiler what is normally slow in this layer, which could help
    to fix the problem quickly.</para>

    <para>In case you use
    <parameter>org.exoplatform.services.jcr.impl.storage.jdbc.optimisation.CQJDBCWorkspaceDataContainer</parameter>
    or
    <parameter>org.exoplatform.services.jcr.impl.storage.jdbc.JDBCWorkspaceDataContainer</parameter>
    as <parameter>WorkspaceDataContainer</parameter>, you can get statistics on the
    time spent on the database access layer. The database access layer (in
    eXo JCR) is represented by the methods of the
    <parameter>org.exoplatform.services.jcr.storage.WorkspaceStorageConnection</parameter> interface,
    so for all the methods defined in this interface, you can have the
    following figures:</para>

    <itemizedlist>
      <listitem>
        <para>The minimum time spent into the method.</para>
      </listitem>

      <listitem>
        <para>The maximum time spent into the method.</para>
      </listitem>

      <listitem>
        <para>The average time spent into the method.</para>
      </listitem>

      <listitem>
        <para>The total amount of time spent into the method.</para>
      </listitem>

      <listitem>
        <para>The total amount of time the method has been called.</para>
      </listitem>
    </itemizedlist>

    <para>Those figures are also available globally for all the methods which
    gives us the global behavior of this layer.</para>

    <para>If you want to enable the statistics, you just need to set the JVM
      parameter called
      <parameter>JDBCWorkspaceDataContainer.statistics.enabled</parameter>
      to
      <emphasis>true</emphasis>. The corresponding CSV file is
      <filename>StatisticsJDBCStorageConnection-${creation-timestamp}.csv</filename>
      for more details about how the csv files are managed. See
      <link linkend="JCR.Statistics.Statistics_Manager">Statistics manager</link>
      for more details.
    </para>
    <para>The format of each column header is <parameter>${method-alias}-${metric-alias}</parameter>.
    The metric alias are described in the statistics manager section.</para>

    <para>The name of the category of statistics corresponding to these
    statistics is <parameter>JDBCStorageConnection</parameter>, this name is
    mostly needed to access to the statistics through JMX.</para>

    <table>
      <title>Method Alias</title>

      <tgroup cols="2">
        <tbody>
          <row>
            <entry><parameter>global</parameter></entry>

            <entry>This is the alias for all the methods.</entry>
          </row>

          <row>
            <entry><parameter>getItemDataById</parameter></entry>

            <entry>This is the alias for the 
            <parameter>getItemData(String identifier)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>getItemDataByNodeDataNQPathEntry</parameter></entry>

            <entry>This is the alias for the
            <parameter>getItemData(NodeData parentData, QPathEntry
            name)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>getChildNodesData</parameter></entry>

            <entry>This is the alias for the <parameter>getChildNodesData(NodeData parent)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>getChildNodesCount</parameter></entry>

            <entry>This is the alias for the <parameter> getChildNodesCount(NodeData parent)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>getChildPropertiesData</parameter></entry>

            <entry>This is the alias for the <parameter>getChildPropertiesData(NodeData parent)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>listChildPropertiesData</parameter></entry>

            <entry>This is the alias for the <parameter>listChildPropertiesData(NodeData parent)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>getReferencesData</parameter></entry>

            <entry>This is the alias for the <parameter>getReferencesData(String nodeIdentifier)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>commit</parameter></entry>

            <entry>This is the alias for the <parameter>commit()</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>addNodeData</parameter></entry>

            <entry>This is the alias for the <parameter>add(NodeData data)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>addPropertyData</parameter></entry>

            <entry>This is the alias for the <parameter>add(PropertyData data)</parameter> mehod.</entry>
          </row>

          <row>
            <entry><parameter>updateNodeData</parameter></entry>

            <entry>This is the alias for the <parameter>update(NodeData data)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>updatePropertyData</parameter></entry>

            <entry>This is the alias for the <parameter>update(PropertyData data)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>deleteNodeData</parameter></entry>

            <entry>This is the alias for the <parameter>delete(NodeData data)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>deletePropertyData</parameter></entry>

            <entry>This is the alias for the <parameter>delete(PropertyData data)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>renameNodeData</parameter></entry>

            <entry>This is the alias for the <parameter>rename(NodeData data)</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>rollback</parameter></entry>

            <entry>This is the alias for the <parameter>rollback()</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>isOpened</parameter></entry>

            <entry>This is the alias for the <parameter>isOpened()</parameter> method.</entry>
          </row>

          <row>
            <entry><parameter>close</parameter></entry>

            <entry>This is the alias for the <parameter>close()</parameter> method.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>

  <section id="JCR.Statistics.Statistics_On_JCR_API_Accesses">
    <title>Statistics on JCR API accesses</title>

    <para>In order to know exactly how your application uses JCR, it can
    be interesting to register all the JCR API accesses in order to easily
    create real life test scenario based on pure JCR calls and also to tune
    your JCR to better fit your requirements.</para>

    <para>In order to allow you to specify the configuration which part of
    JCR needs to be monitored without applying any changes in your code
    and/or building anything, choose to rely on the Load-time Weaving
    proposed by AspectJ.</para>

    <para>To enable this feature, you will have to add the
    following jar files to your classpath:</para>

    <itemizedlist>
      <listitem>
        <para><filename>exo.jcr.component.statistics-X.Y.Z.jar</filename> 
        corresponding to your eXo JCR version that you can get from the jboss
        maven repository <ulink
        url="https://repository.jboss.org/nexus/content/groups/public/org/exoplatform/jcr/exo.jcr.component.statistics">https://repository.jboss.org/nexus/content/groups/public/org/exoplatform/jcr/exo.jcr.component.statistics</ulink>.</para>
      </listitem>

      <listitem>
        <para><filename>aspectjrt-1.6.8.jar</filename> that you can get from the main maven
        repository <ulink
        url="http://repo2.maven.org/maven2/org/aspectj/aspectjrt"><uri>http://repo2.maven.org/maven2/org/aspectj/aspectjrt</uri></ulink>.</para>
      </listitem>
    </itemizedlist>

    <para>You will also need to get <filename>aspectjweaver-1.6.8.jar </filename> from the main
    maven repository <ulink
    url="http://repo2.maven.org/maven2/org/aspectj/aspectjweaver">http://repo2.maven.org/maven2/org/aspectj/aspectjweaver</ulink>.
    At this stage, to enable the statistics on the JCR API accesses, you will
    need to add the JVM parameter
    <emphasis>-javaagent:${pathto}/aspectjweaver-1.6.8.jar</emphasis> to your
    command line. For more details, refer to <ulink
    url="http://www.eclipse.org/aspectj/doc/released/devguide/ltw-configuration.html">http://www.eclipse.org/aspectj/doc/released/devguide/ltw-configuration.html</ulink>.</para>

    <para>By default, the configuration will collect statistics on all the
    methods of the internal interfaces
    <parameter>org.exoplatform.services.jcr.core.ExtendedSession</parameter> and
    <parameter>org.exoplatform.services.jcr.core.ExtendedNode</parameter>, and
    the JCR API interface <parameter>javax.jcr.Property</parameter>. To add
    and/or remove some interfaces to/from monitor, you have two configuration files
    changed that are bundled into the <filename>exo.jcr.component.statistics-X.Y.Z.jar</filename> which includes
    <filename>conf/configuration.xml</filename> and <filename>META-INF/aop.xml</filename>.</para>

    <para>The file content below is the content of
    <filename>conf/configuration.xml</filename> that you will need to modify
    to add and/or remove the full qualified name of the interfaces to monitor,
    into the list of parameter values of the init param called
    <parameter>targetInterfaces</parameter>.</para>

<programlisting language="xml">&lt;configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.exoplatform.org/xml/ns/kernel_1_2.xsd http://www.exoplatform.org/xml/ns/kernel_1_2.xsd"
 xmlns="http://www.exoplatform.org/xml/ns/kernel_1_2.xsd"&gt;

 &lt;component&gt;
   &lt;type&gt;org.exoplatform.services.jcr.statistics.JCRAPIAspectConfig&lt;/type&gt;
   &lt;init-params&gt;
     &lt;values-param&gt;
       &lt;name&gt;targetInterfaces&lt;/name&gt;
       &lt;value&gt;org.exoplatform.services.jcr.core.ExtendedSession&lt;/value&gt;
       &lt;value&gt;org.exoplatform.services.jcr.core.ExtendedNode&lt;/value&gt;
       &lt;value&gt;javax.jcr.Property&lt;/value&gt;
     &lt;/values-param&gt;
   &lt;/init-params&gt;
  &lt;/component&gt;
&lt;/configuration&gt;</programlisting>

    <para>The file content below is the content of
    <filename>META-INF/aop.xml</filename> that you will need to modify to
    add and/or remove the full qualified name of the interfaces to monitor,
    into the expression filter of the pointcut called
    <parameter>JCRAPIPointcut</parameter>. As you can see below, by default only JCR API calls from the exoplatform packages are taken into account, do not
    hesitate to modify this filter to add your own package names.</para>

<programlisting language="xml">&lt;aspectj&gt;
  &lt;aspects&gt;
    &lt;concrete-aspect name="org.exoplatform.services.jcr.statistics.JCRAPIAspectImpl" extends="org.exoplatform.services.jcr.statistics.JCRAPIAspect"&gt;
      &lt;pointcut name="JCRAPIPointcut"
        expression="(target(org.exoplatform.services.jcr.core.ExtendedSession) || target(org.exoplatform.services.jcr.core.ExtendedNode) || target(javax.jcr.Property)) &amp;amp;&amp;amp; call(public * *(..))" /&gt;
    &lt;/concrete-aspect&gt;
  &lt;/aspects&gt;
  &lt;weaver options="-XnoInline"&gt;
    &lt;include within="org.exoplatform..*" /&gt;
  &lt;/weaver&gt;
&lt;/aspectj&gt;</programlisting>

    <para>The corresponding CSV files are of the
    <parameter>Statistics${interface-name}-${creation-timestamp}.csv</parameter> type.
    See <link linkend="JCR.Statistics.Statistics_Manager">Statistics manager</link> for more details about how the csv files are managed.</para>

    <para>The format of each column header is <parameter>${method-alias}-${metric-alias}</parameter>.
    The method alias will be of the <parameter>${method-name}</parameter> type (a list of parameter types
    separated by semicolon (;) to be compatible with the CSV format).</para>

    <para>The name of the category of statistics corresponding to these
    statistics is the simple name of the monitored interface (for example,
    <parameter>ExtendedSession</parameter> for <filename>org.exoplatform.services.jcr.core.ExtendedSession</filename>),
    this name is mostly needed to access the statistics through JMX.</para>

    <note>
      <para>This feature will affect the eXo JCR performance, so it is recommended you use this feature carefully.
      </para>
    </note>
  </section>
</section>
